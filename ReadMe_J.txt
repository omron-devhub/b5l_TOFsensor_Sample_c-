B5L Sample Code (C++)



0. はじめに
このSample Codeは、OMRON製のToFセンサ、B5Lシリーズと通信しパラメータの確認・設定、距離画像の取得を行います。
Interactive ModeとNon-Interactive Modeがあり、後者では指定された条件で自動的に計測を行います。
本Sample CodeはC++/C言語で書かれており、Linux(Raspberry Pi OS Buster, Ubuntu 20.04)及びWindows10で動作確認をしています。

1. ファイル説明とビルド方法
本Sample Codeには以下のファイルが含まれています。

   build.sh             [   Linux   ] コンパイル用シェルスクリプト
   connect_tof.sh       [   Linux   ] ToF接続用シェルスクリプト(ToF_Sample実行でうまくいかないときに使用してください)
   DetectionCuboid.pdf  [ Win/Linux ] 検出領域設定例の説明図
   init_gpio7.sh        [RaspberryPi] GPIO 7番ピンの出力設定用シェルスクリプト
   ToF_Sample.cpp       [ Win/Linux ] サンプルコード本体
   ToF_Sample.prm       [ Win/Linux ] パラメータ設定ファイル
   ToF_Sample.sln       [  Windows  ] Visual Studio 2019用ソリューションファイル
   ToF_Sample.vcxproj   [  Windows  ] Visual Studio 2019用プロジェクトファイル
   TOFApiZ.cpp          [ Win/Linux ] B5Lコマンド通信コード
   TOFApiZ.h            [ Win/Linux ] B5Lコマンド通信コードヘッダ
   uart.h               [ Win/Linux ] シリアル通信用コードヘッダ
   uart_linux.c         [   Linux   ] シリアル通信用コード
   uart_windows.c       [  Windows  ] シリアル通信用コード

Linuxでは、添付のbuild.shを実行することで実行ファイルToF_Sampleが作成されます。
Windows10では、Visual Studio 2019でToF_Sample.slnを開きBuildすることができます。

2. Interactive Mode
Interactive Modeでは、B5Lのコマンドを１つずつ手動で発行して動作を確認することができます。
コマンドを選択すると、パラメータを持たないコマンドであれば即座に実行されます。
結果出力を伴う場合は格納するファイル名を求められ、これを指定すると実行されます。指定しない場合は実行は中止されます。
パラメータを変更するコマンドは、まず現在の設定値が表示され変更する値を求められます。値を入力すれば変更され、しなければ中止されます。


3. Non-Interactive Mode
Non-Interactive Modeでは、パラメータファイルの設定値で指定したフレーム数(あるいはCtrl+Cで停止されるまで)の測距を行い、結果をファイルに出力します。
また検出領域が指定されていた場合、条件が満たされた際に指定したコマンドが実行されます(6-5.検出領域機能参照)。
この機能は、移動ロボットに搭載した際の障害物検知をイメージしています。


4. パラメータファイル
Non-Interactive Modeでは、引数でパラメータファイルを指定する必要があります。
この内容に従ってB5Lのパラメータが初期化されます。
また、出力フォルダの指定などSample Codeの動作も設定します。
パラメータの内容については、ファイルのコメントやB5LのUser's Manualを参照してください。
パラメータは指定がある度にB5Lに設定されるため、同じパラメータを複数指定した場合後から指定したものが有効になります。
指定がないパラメータは更新されません。出力フォルダの指定がない場合はファイル出力されません。カレントディレクトリに出力したい場合は、"."を指定してください。


5. Sample Code独自の処理について
本Sample Codeは基本的にB5Lの機能をそのままC++/Cから利用できるようにすることを主眼としていますが、いくつか追加の機能などがあります。

5-1. BMP File出力
極座標形式の距離データと振幅データは、B5Lの出力そのままだけではなくBMPファイル形式に変換したものも出力します。
極座標形式の距離データは、近距離を赤く遠距離を青く表現したカラーBMP画像に変換されます。
また、同時に.dptファイルとしてB5Lの出力した距離データがそのまま出力されます。
振幅データの場合は0〜255のグレーBMP画像に変換されます。
いずれのBMPデータもLow Amplitudeは黒、OverflowとSatulationは白になります。

5-2. PCD画像形式の変換について(float化、xyzi)
PCD画像出力となる直交座標形式の場合、使い勝手を改善するためB5Lの標準フォーマットから2点変更しています。
各座標値は、標準の2Bytes Integerから8Bytes Floatに変換されます。
また、Amplitudeデータが出力されるモードでは、xyzフォーマットではなく、xyziフォーマットで出力されます。
この際のiフィールドは、Amplitudeデータを距離情報によって1m位置での1 Byte値に換算したものとなります。

5-3. RAW Data出力
ToF_Sample.cppでRAW_OUTPUTを1と定義すると、すべての結果取得フォーマットでB5Lのバイナリ出力がそのまま.rawファイルとして出力されます。
0と定義することで、上記のようなBMP・PCDファイル出力となります。
RAW Data出力の場合は、以下の有効視野範囲外マスク機能・検出領域機能は働きません。

5-4. 有効視野範囲外マスク機能(Non-Interactive Modeのみ)
パラメータファイルでFOV_LIMITATION=1を指定すると、距離データ(PCDデータ)出力から視野外の画素が除かれます。
またこの場合、出力されるPCDデータのフォーマットはUnorganized Datasetsとなります。

5-5. 検出領域機能(Non-Interactive Modeのみ)
パラメータファイルでDETECTION_CUBOIDを指定することにより、直交座標形式でPCDファイルが出力される場合に、指定された直方体の内部に含まれる点の数を閾値と比較してコマンドを実行することができます。
領域は0〜9の最大10個を指定することができ、同じ番号を複数回指定すると後から指定したものが有効になります。
領域は2点のXYZ座標で指定し、X・Y・Z軸に垂直な6面で構成される直方体が指定されます。
この中に含まれる点の数が閾値以上の場合(閾値が正の場合)または未満の場合(閾値が負の場合)、指定したコマンドが実行されます。閾値が0の場合は、設定は無効となります。
FOV_LIMITATIONが有効な場合、視野外の画素は計数に含まれません。
なお、前述のように出力フォルダの指定をしない場合、画像ファイルは出力されません。
本機能のみ使用する場合に活用ください。


[使用上の注意]
* 本サンプルコードおよびドキュメントの著作権はオムロンに帰属します。
* 本サンプルコードは動作を保証するものではありません。
* 本サンプルコードは、Apache License 2.0にて提供しています。

----
オムロン株式会社
Copyright 2019-2022 OMRON Corporation、All Rights Reserved.
